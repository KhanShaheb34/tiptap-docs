---
title: Compare Snapshots of your Document
meta:
  title: Snapshot Compare extension | Tiptap Editor Docs
  description: Compare snapshots of versions of your documents to see changes made between two versions.
  category: Collaboration
extension:
  name: SnapshotCompare
  description: 'Compare snapshots of versions of your documents to see changes made between two versions.'
  type: extension
  icon: FileStack
  isPro: true
  isNew: true
  isCloud: true
---

import { Callout } from '@/components/ui/Callout'
import { CodeDemo } from '@/components/CodeDemo'

The snapshot compare extension allows you to display changes that have been made to the document between two snapshots. This is useful for showing changes that have been made to the document since the last snapshot.

<CodeDemo isPro path="/Extensions/SnapshotCompare" />

## Install

<Callout title="Set up access to Tiptap’s private repository" variant="info">
  Gain access to this pro extension by registering for a free [Tiptap
  account](https://cloud.tiptap.dev/register) and following our [access
  guide](/guides/pro-extensions) to Tiptap’s private repository.
</Callout>

```bash
npm install @tiptap-pro/extension-snapshot-compare
```

## Settings

| Setting              | Type                   | Default    | Description                                                                                   |
| -------------------- | ---------------------- | ---------- | --------------------------------------------------------------------------------------------- |
| provider             | `TiptapCollabProvider` | `null`     | The Collaboration provider instance                                                           |
| mapDiffToDecorations | `function`             | `() => {}` | Allows you to control mapping of a diff into a decoration to display the content of that diff |

## Storage

The `snapshotCompare` storage object contains the following properties:

| Key             | Type                  | Description                                   |
| --------------- | --------------------- | --------------------------------------------- |
| isPreviewing    | `boolean`             | Whether the diff view is currently active     |
| diffs           | `Diff[]`              | The diffs that are displayed in the diff view |
| previousContent | `JSONContent \| null` | The content before the diff view was applied  |

### Examples

To know that you are currently previewing the diff view, you can check the `isPreviewing` property.

```ts
if (editor.storage.snapshotCompare.isPreviewing) {
  // The diff view is currently active
}
```

To access the diffs that are displayed in the diff view, you can access the `diffs` property.

```ts
editor.storage.snapshotCompare.diffs
```

## Commands

| Command                              | Description                                                              |
| ------------------------------------ | ------------------------------------------------------------------------ |
| [compareVersions](#compare-versions) | Diffs two versions and renders the diff into the dom element you specify |
| showDiff                             | Given a change tracking transform, show the diff within the editor       |
| hideDiff                             | Hide the diff and restore the previous content                           |

### `compareVersions`

To compare two versions of the document, you can use the `compareVersions` command. This will diff the two versions and display the diff within the editor.

```ts
editor.chain().compareVersions({
  fromVersion: 1,
  toVersion: 3,
})
```

Each diff has an `attribution` field, which allows for adding additional metadata to the diff with the `hydrateUserData` callback function.

This example adds colors to the diffs based on the user that made the change with a predifined color mapping.

```ts
const colorMapping = new Map([
  ['user-1', '#ff0000'],
  ['user-2', '#00ff00'],
  ['user-3', '#0000ff'],
])

editor.chain().compareVersions({
  fromVersion: 1,
  toVersion: 3,
  hydrateUserData: ({ userId }) => {
    return {
      color: {
        backgroundColor: colorMapping.get(userId),
      },
    }
  },
})

editor.storage.snapshotCompare.diffs[0].attribution.color.backgroundColor // '#ff0000'
```

Do you need more control over the diffing process? You can receive the result of the diffing process and handle it yourself.

```ts
editor.chain().compareVersions({
  fromVersion: 1,
  toVersion: 3,
  onCompare: (ctx) => {
    if (ctx.error) {
      // handle errors that occurred in the diffing process
      console.error(ctx.error)
      return
    }

    // filter the diffs to display only the changes made by a specific user
    const diffsToDisplay = ctx.diffSet.filter((diff) => diff.attribution.userId === 'user-1')

    editor.commands.showDiff(ctx.tr, { diffs: diffsToDisplay })
  },
})
```

#### `compareVersions` Options

For more control over the diffing process, you can pass in additional options:

- `fromVersion`: The version number to diff from. (order does not matter between `fromVersion` and `toVersion`)
- `toVersion`: The version number to diff to. (Defaults to the latest version)
- `onCompare`: If provided, allows customizing the behavior of rendering the diffs to the editor.
- `hydrateUserData`: Allows adding contextual data to each user's changes.
- `mapDiffToDecorations`: Allows configuring how the diffs are mapped into decorations to display the content of that diff.
- `enableDebugging`: Verbosely log the diffing process to help track down where things went wrong.

### `showDiff`

If you opt to manually handle the diffing process, you can use the `showDiff` command to display the result in the editor.

When diffing versions, you'll be given a change tracking transform which represents all of the changes that have been made to the document since the last snapshot. You can use this transform to show the diff in the editor.

It will stash the current displayed editor content and replace it with the diff view. The diff view will show the changes that have been made to the document since the last snapshot.

Optionally, you can pass in the diffs to visualize if you choose to modify them in some way.

```ts
// This will display the changes that change tracking transform recorded in the editor
editor.commands.showDiff(tr)
```

To gain more control over the diffs to display, you can pass in the diffs to visualize.

```ts
// This will display only the diffs made by the user with the ID 'user-1'
const diffsToDisplay = tr.toDiff().filter((diff) => diff.attribution.userId === 'user-1')

editor.commands.showDiff(tr, { diffs: diffsToDisplay })
```

### `hideDiff`

If you want to hide the diff and restore the previous content, you can use the `hideDiff` command.

```ts
// This will hide the diff view and restore the previous content
editor.commands.hideDiff()
```

### `mapDiffToDecorations` (Advanced)

The `SnapShotCompare` extension has a default mapping (`defaultMapToDecorations`) for representing the diffs as prosemirror decorations.
However, for more complex integrations and control this can be customized to fit your needs.

The `mapDiffToDecorations` option allows you to control how the diffs are mapped into decorations to display the content of that diff.

```ts
editor.chain().compareVersions({
  fromVersion: 1,
  toVersion: 3,
  mapDiffToDecorations: ({ diff, tr, editor, defaultMapToDecorations }) => {
    if (diff.type === 'inline-insert') {
      // return prosemirror decoration(s) or null
      return Decoration.inline(
        diff.from,
        diff.to,
        {
          class: 'diff',
          style: {
            backgroundColor: diff.attribution.color.backgroundColor,
          },
        },
        // pass the diff as the decoration's spec, this is required for `extractAttributeChanges`
        { diff },
      )
    }

    // fallback to the default mapping
    return defaultMapToDecorations({ diff, tr, editor })
  },
})
```

## Working with Nodeviews (Advanced)

If you are using custom nodeviews, the default mapping may not work as expected. You can customize the mapping to fit your needs, such as rendering the diffs within the custom nodeview.

There is a helper function `extractAttributeChanges` that can be used to extract which attributes have changed between two versions of a node.

<Callout title="TES" variant="info">
  If you are mapping the diffs into decorations yourself, you need to pass `diff` as the decorations
  spec. This is required for `extractAttributeChanges` to work.
</Callout>

```ts
import { extractAttributeChanges } from '@tiptap-pro/extension-snapshot-compare'

const Heading = BaseHeading.extend({
  addNodeView() {
    return ReactNodeViewRenderer(({ node, decorations }) => {
      const { before, after, isDiffing } = extractAttributeChanges(decorations)

      return (
        <NodeViewWrapper style={{ position: 'relative' }}>
          {isDiffing && before.level !== after.level && (
            <span
              style={{
                position: 'absolute',
                right: '100%',
                fontSize: '14px',
                color: '#999',
                backgroundColor: '#f0f0f070',
              }}
              // Display the difference in level attribute
            >
              #<s>{before.level}</s>
              {after.level}
            </span>
          )}
          <NodeViewContent as={`h${node.attrs.level ?? 1}`} />
        </NodeViewWrapper>
      )
    })
  },
})
```

## Technical details

### Diff

A `Diff` is an object that represents a change made to the document. It contains the following properties:

- `type: 'inline-insert' | 'inline-delete' | 'block-insert' | 'block-delete' | 'inline-update' | 'block-update'` The type of change that was made.
- `from: number` The start position of the change.
- `to: number` The end position of the change.
- `content: Fragment` The content that was added or removed.
- `attribution: Attribution` Metadata about the change, such as the user who made the change.
- `attributes?: Record<string, any>` Only available for `inline-update` and `block-update` diffs. The attributes after the change was made.
- `previousAttributes?: Record<string, any>` Only available for `inline-update` and `block-update` diffs. The attributes before the change was made.

### DiffSet

A `DiffSet` is just an array of `Diff` objects.

### Attribution

The `Attribution` object represents metadata about a change. It contains the following properties:

- `type: 'added' | 'removed'` The type of change that was made.
- `userId: string | undefined` The ID of the user who made the change.
- `id: Y.ID | undefined` The Y.js client id of the user who made the change.

It can be extended to include more properties like this:

```ts
declare module '@tiptap-pro/extension-snapshot-compare' {
  interface Attribution {
    userName: string
  }
}
```

### ChangeTrackingTransform

The `ChangeTrackingTransform` is a class that records changes made to the document based on Prosemirror's `Transform` class.
It represents a transform whose steps describe all of the changes to go from one version of the document to another.

`ChangeTrackingTransform` has the following properties:

- `steps: ChangeTrackingStep[]` An array of steps that represent the changes made to the document.
- `doc: Node` The document after the changes have been applied.
- `before: Node` The document before the changes have been applied.

### ChangeTrackingStep

The `ChangeTrackingStep` is a class that represents a single change made to the document, based on Prosemirror's `ReplaceStep` class.

`ChangeTrackingStep` has the following additional properties:

- `attribution: Attribution` Metadata about the change, such as the user who made the change.
